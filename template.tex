\documentclass[
  fontsize=10,
  DIV=11,
  fromlogo=true,
]{scrlttr2}

\KOMAoptions{%
  paper=a4,
  foldmarks=false,
  fromalign=right,
  fromlogo=true,
  $if(from.phone)$
    fromphone=true,
  $endif$
  $if(from.url)$
    fromurl=true,
  $endif$
  $if(from.email)$
    fromemail=true,
  $endif$
  backaddress=true,
  parskip=half,
  enlargefirstpage=true,
}

%-------------------------------------------------------------------------------
% COMMON PACKAGES
%-------------------------------------------------------------------------------
\usepackage[$lang$]{babel}   % language and autolinebreak
\usepackage[utf8]{inputenc}  % for utf-8 encoding
\usepackage{xparse}          % new document command
\usepackage{xcolor}          % colors
\usepackage{graphicx}        % box commands for graphics
\usepackage{ifthen}          % if then else
\usepackage{hyperref}        % hyper ref
\usepackage{tabularx}        % tabular for progress bar
\usepackage{varwidth}        % variable block size
\usepackage{ragged2e}        % alt commands that fix hyphenation issues

%-------------------------------------------------------------------------------
% FONT
%-------------------------------------------------------------------------------
\usepackage[T1]{fontenc}
\usepackage{fontspec}
\setmainfont{Open Sans}

%-------------------------------------------------------------------------------
% PARAGRAPH
%-------------------------------------------------------------------------------
\linespread{1.1}

\setlength\parskip{1ex}

\setkomavar{backaddressseparator}{~{$$\vcenter{\hbox{\scalebox{0.5}{$$\bullet$$}}}$$} }

\makeatletter
% spacing between \closing and signature
\@addtoplength{sigbeforevskip}{-\baselineskip}
% spacing between top border and firstheader
\@addtoplength{firstheadvpos}{\baselineskip}
% MWE: increase size of backaddress field in addressee (window of envelope) to make it fit there
\@addtoplength{backaddrheight}{2\baselineskip}

% alignment of header and addressee %http://tex.stackexchange.com/questions/64690/aligning-address-with-body-of-letter-in-scrlttr2
\@setplength{toaddrhpos}{\dimexpr 1in +\oddsidemargin\relax}
\@setplength{toaddrwidth}{8cm}
\@setplength{toaddrindent}{0cm}
\@setplength{firstheadhpos}{\dimexpr 1in +\oddsidemargin\relax}
\@setplength{firstheadwidth}{\textwidth}
\makeatother

\setkomafont{title}{\bfseries\normalsize\raggedright}

\renewcommand\raggedsignature{\raggedright}

%-------------------------------------------------------------------------------
% LISTS
%-------------------------------------------------------------------------------
\usepackage{enumitem}                           % For customizing lists

% Command required by how Pandoc handles the list conversion
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

\setlist{nolistsep}                             % No whitespace around list items
\setlist[itemize]{
  topsep=1ex,
  leftmargin=2em,
}

%-------------------------------------------------------------------------------
% TABLE CUSTOMISATION
%-------------------------------------------------------------------------------
\usepackage{spreadtab}
\usepackage[compact]{titlesec} % For customizing title sections
\titlespacing*{\section}{0pt}{0.5ex}{-1ex} % Remove margin bottom from the title
\usepackage{arydshln} % For the dotted line on the table
\renewcommand{\arraystretch}{1.2} % Apply vertical padding to table cells
\usepackage{hhline} % For single-cell borders
\setlength{\tabcolsep}{0.2em}                   % Gutter between columns

\newcolumntype{L}{>{\RaggedRight\arraybackslash\hsize=  .08\hsize}X}
\newcolumntype{M}{>{\RaggedRight\arraybackslash\hsize=  .10\hsize}X}
\newcolumntype{N}{>{\RaggedRight\arraybackslash\hsize=  .15\hsize}X}
\newcolumntype{C}{>{\Centering\arraybackslash\hsize=    .05\hsize}X}
\newcolumntype{R}{>{\RaggedLeft\arraybackslash\hsize=   .08\hsize}X}
\newcolumntype{S}{>{\RaggedLeft\arraybackslash\hsize=   .18\hsize}X}
\newcolumntype{T}{>{\RaggedLeft\arraybackslash\hsize=   .20\hsize}X}
\newcolumntype{U}{>{\RaggedLeft\arraybackslash\hsize=   .30\hsize}X}

\newcounter{pos}

%-------------------------------------------------------------------------------
% ADDRESSBLOCKS
%-------------------------------------------------------------------------------
\makeatletter
\def\shortsender{%
  $if(from.name)$
    $from.name$\\
  $endif$
  $if(from.company)$
    $from.company$\\
    $if(from.name)$
    $else$
      $if(from.department)$
        $from.department$\\
      $endif$
    $endif$
  $endif$
  $if(from.street)$
    $from.street$\\
  $endif$
  $if(from.format.us)$
    $if(from.city)$
      $from.city$%
    $endif$
    $if(from.postal)$
      \\ $from.postal$%
    $endif$
  $endif$
  $if(from.format.eu)$
    \\
    $if(from.postal)$
      $from.postal$%
    $endif$
    $if(from.city)$
      $from.city$%
    $endif$
  $endif$
}

\def\sender{%
  $if(from.name)$
    $from.name$\\
  $endif$
  $if(from.department)$
    $from.department$\\
  $endif$
  $if(from.company)$
    $from.company$\\
  $endif$
  $if(from.street)$
    $from.street$
  $endif$
  $if(from.suffix)$
    $if(from.format.us)$
      , $from.suffix$
    $endif$
    $if(from.format.eu)$
      \\ $from.suffix$
    $endif$
  $endif$
  $if(from.format.us)$
    \\
    $if(from.city)$
      $from.city$
    $endif$
    $if(from.postal)$
      , $from.postal$
    $endif$
  $endif$
  $if(from.format.eu)$
    \\
    $if(from.postal)$
      $from.postal$
    $endif$
    $if(from.city)$
      $from.city$
    $endif$
  $endif$
  $if(from.state)$
    \\ $from.state$
  $endif$
  $if(from.country)$
    \\ $from.country$
  $endif$
}

\def\recipient{%
  $if(to.name)$
    $to.name$\\
  $endif$
  $if(to.department)$
    $to.department$\\
  $endif$
  $if(to.company)$
    $to.company$\\
  $endif$
  $if(to.street)$
    $to.street$
  $endif$
  $if(to.suffix)$
    $if(to.format.us)$
      , $to.suffix$
    $endif$
    $if(to.format.eu)$
      \\ $to.suffix$
    $endif$
  $endif$
  $if(to.format.us)$
    \\
    $if(to.city)$
      $to.city$
    $endif$
    $if(to.postal)$
      , $to.postal$
    $endif$
  $endif$
  $if(to.format.eu)$
    \\
    $if(to.postal)$
      $to.postal$
    $endif$
    $if(to.city)$
      $to.city$
    $endif$
  $endif$
  $if(to.state)$
    \\ $to.state$
  $endif$
  $if(to.country)$
    \\ $to.country$
  $endif$
}

\def\mainsubject{%
  $if(invoice.title)$
    $invoice.title$
  $endif$
  $if(invoice.with-number)$
    $if(invoice.number)$
      $invoice.number$
    $endif$
  $endif$
}
\makeatother

\makeatletter
\setkomavar{backaddress}{%
  \begin{varwidth}{\useplength{toaddrwidth}}{%
    \def\\{\usekomavar{backaddressseparator}\@ogobble}%
      \shortsender
    }
  \end{varwidth}%
}
\makeatother

%-------------------------------------------------------------------------------
% DOCUMENT DOCUMENTDATA
%-------------------------------------------------------------------------------
\begin{document}

\setkomavar{fromlogo}{\smash{\raisebox{1cm}{\includegraphics[width=3cm]{%
  $if(from.logopath)$
    $from.logopath$
    $else$
      example-image
    $endif$
}}}}

\setkomavar{fromname}{$author$}
\setkomavar{fromaddress}{\sender}
$if(from.phone)$
  \setkomavar{fromphone}[]{\href{tel:$from.phone$}{$from.phone$}}
$endif$
$if(from.url)$
  \setkomavar{fromurl}[]{$from.url$}
$endif$
$if(from.email)$
  \setkomavar{fromemail}[]{\href{mailto:$from.email$}{$from.email$}}
$endif$

$if(place)$
  \setkomavar{place}{$place$}
$endif$
$if(date)$
  \setkomavar{date}{$date$}
$else$
  \setkomavar{date}{\today}
$endif$

\setkomavar{subject}{\mainsubject}


%-------------------------------------------------------------------------------
% LETTER
%-------------------------------------------------------------------------------
\begin{letter}{\recipient}

\opening{$openingnote$}

\small
$if(autoround)$
  \STautoround*{$autoround$}
$else$
  \STautoround*{2}
$endif$
$if(commasep)$
  \STsetdecimalsep{,}
$endif$ % Use comma as decimal separator

  \begin{spreadtab}{{tabularx}{\linewidth}[t t t]{@{}RX SN C TM UM}}
  \hdashline[1pt/1pt]%
    @ \scriptsize\textbf{Pos.}%
  & @ \scriptsize\textbf{Description}%
  & @ \scriptsize\textbf{Amount}%
  & @ \scriptsize\textbf{Unit}%
  & @ %
  & @ \scriptsize\textbf{U-Price}%
  & @ \scriptsize\textbf{Curr}%
  & @ \scriptsize\textbf{Price}%
  & @ \scriptsize\textbf{Curr}%
  \\ \hline%
  $for(service)$%
      @ \hspace*{\fill}\refstepcounter{pos}\thepos%
    & @ $service.description$%
      $if(service.details)$\begin{itemize}
        $for(service.details)$\scriptsize \item $service.details$
        $endfor$ \end{itemize}
      $endif$%
    & $service.amount$%
    & @ $service.unit$%
    & @ at
    & $service.rate$
    & @ $invoice.currency$
    & :={[-5,0]*[-2,0]}%
    % & $service.price$%
    & @ $invoice.currency$%
    \\$endfor$ \noalign{\vskip 1ex} \hline
  $if(VAT)$
      @%
    & @ \multicolumn{1}{l}{Subtotal:}%
    & @ & @ & @ & @ & @%
    & :={sum(h1:[0,-1])}%
    & @ $invoice.currency$%
    \\ \hhline{~~~~~~~--}
      @%
    & @ \multicolumn{1}{l}{VAT :}%
    & @ & @ & @%
    & @ \multicolumn{2}{c}{$VAT$\,\%}%
    & $VAT$/100*[0,-1]%
    & @ $invoice.currency$%
    \\ \hhline{~~~~~~~--}
  $endif$
    @%
  & @ \multicolumn{1}{l}{\textbf{Total:}}%
  & @ & @ & @ & @ & @%
  & \textbf{:={$if(VAT)$[0,-1]+[0,-2]$else$sum(h1:[0,-1])$endif$}}%
  & @ $invoice.currency$%
  \\ \hhline{~~~~~~~--}
\end{spreadtab}

\vspace{4ex}

\sffamily
$closingnote$

\medskip

\vfill
\closing{Sincerely,}

\end{letter}

\end{document}

